<!DOCTYPE html>
<html>
	<head>
		<title>Snake</title>
		<meta charset="UTF-8"/>
		<style type="text/css">
			canvas {
				border: 1px solid black;
				float:left;
				margin: 30px;
			}
			#panel{
				float:left;
				padding:20px;
			}
			h1{
				margin-left: 20px;
			}
			h2{
				font-size:35px;
			}
		</style>
	</head>
	<body>
		<h1>Level <span id="level-heading">1</span></h1>
		<canvas tabindex="0" width="600" height="600" id="canvas">

		</canvas>

		<div id="panel">
			<h2>Your score: <span id="score">0</span></h2>

			<label for="level">Level:</label><br>
			<input type="number" id="level" name="level" min="1" max="5" value="1"><br>

			<label for="powerTime">Power-ups time:</label><br>
			<input type="range" id="powerTime" name="powerTime" min="100" step="1" max="5000" value="1000" onchange="setPowerTime(this.value);"><br>

			<label for="powerUnit">Power-ups units:</label><br>
			<input type="number" id="powerUnit" name="powerUnit" min="1" max="5" value="1" onchange="setPowerUnits(this.value);"><br>

			<label for="snakeSpeed">Snake speed:</label><br>
			<input type="range" id="snakeSpeed" name="snakeSpeed" step="1" min="1" max="250" value="150" onchange="setSnakeSpeed(this.value);"><span id="speed">150</span><br><br>

			<button onclick="init()">Start</button>
		</div>
		<script type="text/javascript">

		var setSpeed = false;
		var speed = 150;
		var speedAmount = document.getElementById("speed");

		function setPowerTime(powerTimeValue){
			powerTimeValues = parseInt(powerTimeValue);
			console.log("czas powerupa: " + powerTimeValues);
		}

		function setPowerUnits(powerUnitValue){
			powerUnitValues = parseInt(powerUnitValue);
			console.log("jednostka powerupa: " + powerUnitValues);
		}

		function setSnakeSpeed(snakeSpeed){
			snakeSpeeds = parseInt(snakeSpeed);
			setSpeed = true;
			speed = snakeSpeeds;
			speedAmount.innerHTML = speed;
		}

			function init(){
				var canvas = document.querySelector("#canvas");
				var ctx = canvas.getContext("2d");

				canvas.focus();

				var level = document.getElementById("level").value;
				var scoreValue = 1;
				var powerTimeValue = 5000;
				var powerUnitValue = 1;
				if(level == 2){
					scoreValue = 2;
					if(!(setSpeed)){
						speed = 120;
						speedAmount.innerHTML = speed;
					}
				} else if(level == 3) {
					scoreValue = 4;
					if(!(setSpeed)){
						speed = 100;
						speedAmount.innerHTML = speed;
				  }
				} else if(level == 4) {
					scoreValue = 8;
					if(!(setSpeed)){
						speed = 70;
						speedAmount.innerHTML = speed;
					}
				} else if(level == 5) {
					scoreValue = 12;
					if(!(setSpeed)){
						speed = 50;
						speedAmount.innerHTML = speed;
					}
				} else {
					scoreValue = 1;
					if(!(setSpeed)){
						speed = 150;
						speedAmount.innerHTML = speed;
					}
				}

				// ---  OBSTACLE CONSTRUCTOR --- //

				function Obstacle(ctx, canvas) {
					this.canvas = canvas;
					this.ctx = ctx;
					this.size = 25;
					this.onBoard = false;
					this.x = 0;
					this.y = 0;
					
					this.randomize = function() {
						this.x = Math.floor(Math.random() * (this.canvas.width/this.size));
						this.y = Math.floor(Math.random() * (this.canvas.height/this.size));
					};

					this.drawObstacle = function() {
						this.ctx.fillStyle = "grey";
						this.ctx.beginPath();
						this.ctx.rect(this.x*this.size,this.y*this.size,this.size,this.size);
						this.ctx.fill();
						this.ctx.closePath();
					};
				}

				// ---  POWER-UP CONSTRUCTOR --- //

				function Power(ctx, canvas) {
					this.canvas = canvas;
					this.ctx = ctx;
					this.size = 25;
					this.onBoard = false;
					this.eatenPower = true;
					this.x = 0;
					this.y = 0;

					this.powerType = 1;
					this.powerTimeValue = powerTimeValues;
					this.powerUnitValue = powerUnitValues;

					this.randomize = function() {
						this.x = Math.floor(Math.random() * (this.canvas.width/this.size));
						this.y = Math.floor(Math.random() * (this.canvas.height/this.size));
					};

					this.drawPower = function() {
						this.ctx.fillStyle = "violet";
						this.ctx.beginPath();
						this.ctx.rect(this.x*this.size,this.y*this.size,this.size,this.size);
						this.ctx.fill();
						this.ctx.closePath();
						this.ctx.fillStyle = "black";
					};
				}


				// ---  APPLE CONSTRUCTOR --- //

				function Apple(ctx, canvas) {
					this.canvas = canvas;
					this.ctx = ctx;
					this.size = 25;
					this.onBoard = false;
					this.x = 0;
					this.y = 0;
					
					this.scoreValue = scoreValue;

					this.randomize = function() {
						this.x = Math.floor(Math.random() * (this.canvas.width/this.size));
						this.y = Math.floor(Math.random() * (this.canvas.height/this.size));
					};

					this.drawApple = function() {
						this.ctx.fillStyle = "green";
						this.ctx.beginPath();
						this.ctx.rect(this.x*this.size,this.y*this.size,this.size,this.size);
						this.ctx.fill();
						this.ctx.closePath();
						this.ctx.fillStyle = "black";
					};
				}

				// ---  SNAKE CONSTRUCTOR --- //

				function Snake(ctx, canvas) {
					var that = this;
					this.canvas = canvas;
					this.ctx = ctx;
					this.speed = speed;
					console.log(speed);
					this.size = 25;
					this.bodyParts= 8;
					this.bodyPartsHolder = [];
					this.direction = "right";
					this.paused = false;
					this.alive = true;
					this.eaten = false;
					this.charged = false;

					this.initSnake = function(){
						for (var i=0; i < this.bodyParts; i++) {
						  this.bodyPartsHolder.push({x:i,y:0});
						};
						this.makeSnakeListen(window);

					};

					this.updatePosition = function(){
						var tempx = this.bodyPartsHolder[this.bodyParts-1].x;
						var tempy = this.bodyPartsHolder[this.bodyParts-1].y;
						var prevX = tempx;
						var prevY = tempy;
						switch(this.direction){
							case "right":
								this.bodyPartsHolder[this.bodyParts-1].x++;
								break;
							case "down":
								this.bodyPartsHolder[this.bodyParts-1].y++;
								break;
							case "left":
								this.bodyPartsHolder[this.bodyParts-1].x--;
								break;
							case "up":
								this.bodyPartsHolder[this.bodyParts-1].y--;
								break;
						}

						for(var i = this.bodyParts-2; i>=0;i--) {
							tempx = this.bodyPartsHolder[i].x;
							tempy = this.bodyPartsHolder[i].y;
							this.bodyPartsHolder[i].x = prevX;
							this.bodyPartsHolder[i].y = prevY;
							prevX = tempx;
							prevY = tempy;
						}
					};

					this.makeSnakeListen = function (window){
						window.onkeydown = function(e){
							switch(e.keyCode){
								case 37:
									if(that.direction != "right"){
										that.direction = "left";
									}
									break;
								case 38:
									if(that.direction != "down"){
										that.direction = "up";
									}
									break;
								case 39:
									if(that.direction != "left"){
										that.direction = "right";
									}
									break;
								case 40:
									if(that.direction != "up"){
										that.direction = "down";
									}
									break;
								case 32 /*spacja*/:
									if(that.paused){
										that.paused = false;
									} else {
										that.paused = true;
										that.ctx.font = "50px serif red";
										that.ctx.fillStyle = "red";
										that.ctx.fillText("PAUZA", 150, 250);
										that.ctx.fillStyle = "black";
									}
									break;
							}
						};
					};

					this.moveSnake = function(){
						this.drawSnake();
						this.updatePosition();
					};

					this.drawSnake = function(){
						for(var i=0; i < this.bodyParts; i++) {
							this.ctx.beginPath();
							this.ctx.rect(this.bodyPartsHolder[i].x*this.size,this.bodyPartsHolder[i].y*this.size,this.size,this.size);
							this.ctx.fill();
							this.ctx.closePath();
						};
					};

					this.checkColissions = function(appleX,appleY,obstacleX,obstacleY,powerX,powerY){
						var sneakHead = this.bodyPartsHolder[this.bodyParts-1];
						if(sneakHead.x*this.size >= canvas.width){
							sneakHead.x = 0
						}
						if(sneakHead.x < 0){
							sneakHead.x = canvas.width/this.size;
						}
						if(sneakHead.y*this.size >= canvas.height){
							sneakHead.y = 0
						}
						if(sneakHead.y < 0){
							sneakHead.y = canvas.height/this.size;
						}
						if(sneakHead.x == appleX && sneakHead.y == appleY){
							this.eaten = true;
						}
						if(sneakHead.x == powerX && sneakHead.y == powerY){
							this.charged = true;
						}
						if(sneakHead.x == obstacleX && sneakHead.y == obstacleY){
							this.alive = false;
						}
						for(var i = 0; i < this.bodyPartsHolder.length-1; i++){
							if(sneakHead.x == this.bodyPartsHolder[i].x && sneakHead.y == this.bodyPartsHolder[i].y){
								this.alive = false;
							}
						}
					};

					this.grow = function(){
						this.bodyParts++;
						this.bodyPartsHolder.unshift({x:-1,y:-1});
					};
				}

				// ---  GAME CONSTRUCTOR --- //

				function Game(canvas, ctx){


					var levelHeading = document.getElementById("level-heading");
					if(level == 2){
						levelHeading.innerHTML = " 2";
					} else if(level == 3) {
						levelHeading.innerHTML = " 3";
					} else if(level == 4) {
						levelHeading.innerHTML = " 4";
					} else if(level == 5) {
						levelHeading.innerHTML = " 5";
					} else {
							levelHeading.innerHTML = " 1";
					}

					var that = this;
					this.canvas = canvas;
					this.ctx = ctx;
					this.width = canvas.width;
					this.height = canvas.height;
					this.state = "New";
					this.snake = new Snake(this.ctx, this.canvas);
					this.apple = new Apple(this.ctx, this.canvas);
					this.power = new Power(this.ctx, this.canvas);
					this.obstacle = new Obstacle(this.ctx, this.canvas);
					this.appleCorrect = true;
					this.powerCorrect = true;
					this.obstacleCorrect = true;
					this.score = 0;

					this.drawWelcome = function() {
						ctx.font = "48px serif";
  						ctx.fillText("Welcome to Snake!", 10, 50);
  						ctx.font = "24px serif";
  						ctx.fillText("Press ENTER to start.", 20, 150);
  						ctx.fillText("Press SPACE to pause.", 20, 180);
  						window.onkeydown = function(e){
							switch(e.keyCode){
								case 13/*enter*/:
									that.state = "PlayGame";
									that.init();
									break;
							}
						};
					};

					this.activateGame = function() {
						this.snake.initSnake();
						this.intervalID = setInterval(function(){
							if(that.snake.eaten){
								that.score += that.apple.scoreValue;
								document.getElementById("score").innerHTML = that.score;
								that.apple.onBoard = false;
								that.snake.grow();
								that.snake.eaten = false;
								that.power.eatenPower = false;
							}

							if(that.snake.charged){
								that.power.onBoard = false;
								that.power.eatenPower = true;
								console.log(that.power.onBoard);
								
								that.snake.charged = false;

								if(that.snake.powerType == 1){
									console.log("skrócić węża o " + that.power.powerUnitValue + "");
								} else if(that.snake.powerType == 2){
									console.log("wydłużyć węża o " + that.power.powerUnitValue + "");
								} else if(that.snake.powerType == 3){
									console.log("przyspieszyć węża na " + that.power.powerTimeValue + " sekund");
								} else if(that.snake.powerType == 4){
									console.log("spowolnić węża na " + that.power.powerTimeValue + " sekund");
								} else if(that.snake.powerType == 5){
									console.log("więcej punktów (standardowa liczba przemnożona przez " + that.power.powerUnitValue + ")");
								} else {
									console.log("sprawić, że wąż może przechodzić przez elementy labiryntu przez " + that.power.powerTimeValue + " sekund");
								}
							}
							if(that.snake.paused != true){
								that.ctx.clearRect(0,0,that.canvas.width,that.canvas.height);
							};

							if(that.obstacle.onBoard) {
								that.obstacle.drawObstacle();
							} else {
								do {
									that.obstacleCorrect = true;
									that.obstacle.randomize();
							for(var k = 0; k < that.snake.bodyPartsHolder.length; k++){
								if(that.obstacle.x == that.snake.bodyPartsHolder[k].x && that.obstacle.y == that.snake.bodyPartsHolder[k].y ){
									that.obstacleCorrect = false;
									break;
								}
							}
						} while(!(that.obstacleCorrect));

						that.obstacle.onBoard = true;
						that.obstacle.drawObstacle();
						}

							if(that.apple.onBoard) {
								that.apple.drawApple();
							} else {
								do {
									that.appleCorrect = true;
									that.apple.randomize();
									for(var i = 0; i < that.snake.bodyPartsHolder.length; i++){
										if(that.apple.x == that.snake.bodyPartsHolder[i].x && that.apple.y == that.snake.bodyPartsHolder[i].y ){
											for(var j = 0; j < that.obstacle.size.length; j++){
												if(that.apple.x == that.obstacle.size[j].x && that.apple.y == that.obstacle.size[j].y ){
													that.appleCorrect = false;
													break;
												}
											}
										}
									}
								} while(!(that.appleCorrect));

								that.apple.onBoard = true;
								that.apple.drawApple();
							}

							if(that.power.onBoard && that.power.eatenPower == false) {
								that.power.drawPower();
							} else if(that.score != 0 && that.score%(that.apple.scoreValue + that.apple.scoreValue) == 0 && that.power.onBoard == false && that.snake.charged == false) {
								do {
									that.powerCorrect = true;
									that.power.randomize();
									for(var l = 0; l < that.snake.bodyPartsHolder.length; l++){
										if(that.power.x == that.snake.bodyPartsHolder[l].x && that.power.y == that.snake.bodyPartsHolder[l].y ){
											for(var m = 0; m < that.obstacle.size.length; m++){
												if(that.power.x == that.obstacle.size[m].x && that.power.y == that.obstacle.size[m].y ){
													that.powerCorrect = false;
													break;
												}
											}
										}
									}
								} while(!(that.powerCorrect));

								that.snake.powerType = Math.floor(Math.random() * 7);
								that.power.onBoard = true;
								that.power.drawPower();
							}

							if(that.snake.alive){
								if(that.snake.paused != true){
									that.snake.moveSnake();
									that.snake.checkColissions(that.apple.x,that.apple.y,that.obstacle.x,that.obstacle.y,that.power.x,that.power.y);
								}
							} else {
								that.ctx.font = "50px serif";
								that.ctx.fillStyle = "red";
								that.ctx.fillText("Snake is dead", 120, 200);
								that.ctx.font = "30px serif";
								that.ctx.fillText("press ENTER", 150, 250);
								that.ctx.fillText("Twoj wynik: "+that.score, 150, 285);
								that.ctx.fillStyle = "black";
								clearInterval(that.intervalID);
								that.state = "GameLost";
								that.init();
							}
						},this.snake.speed);
					};
					this.init = function() {

						switch(this.state){
							case "New":
								this.drawWelcome();
								break;
							case "PlayGame":
								this.activateGame();
								break;
							case "GameLost":
								window.onkeydown = function(e){
								switch(e.keyCode){
									case 13/*enter*/:
										that.score = 0;
										that.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
										that.snake = null;
										that.snake = new Snake(that.ctx, that.canvas);
										that.apple = new Apple(that.ctx, that.canvas);
										that.power = new Power(that.ctx, that.canvas);
										that.obstacle = new Obstacle(that.ctx, that.canvas);
										that.state = "New";
										that.init();
										break;
									}
								};
								break;
						}
					};
				};

				var gra = new Game(canvas, ctx);
				gra.init();

			}
		</script>
	</body>
</html>
